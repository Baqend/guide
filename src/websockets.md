# Websocket: Protocol Description

We recommend using one of Baqend's SDKs to develop an application, but you can also directly access the underlying communication protocols: 
This document describes what messages are sent between client and server to enable real-time queries, i.e. to provide the client with low-latency updates to query results. The information provided here is intended to cover low-level details that are not part of our client SDK documentation: To get a basic understanding of event message semantics, message format, legal values etc., please read our docs on [Event Stream Queries](./topics/realtime/#event-stream-queries) first.  
(For information on the messaging protocol use for request-response communication between client and server, see our [REST API Docs](./topics/rest-api/).)

You can establish a websocket connection to your app through the following endpoints:

- `ws://<app-name>.events.baqend.com/v1/events` (cleartext) 
- `wss://<app-name>.events.baqend.com/v1/events` (TLS-encrypted) 

## Real-Time Query Lifecycle

A real-time query is always initialized through a **subscribe message** sent from the client to the server. After subscription, the client only listens for messages sent by the server, until the query is canceled. A real-time query can only be canceled in two ways: explicitly through an **unsubscribe message** (issued by the client) or implicitly through an **error message** (issued by the server). 

Between subscription (=initialization) and unsubscription (=termination) of a real-time query, messages are only sent from the server to the client. To guarantee correct semantics, the client should process messages in strict order of their occurrence.  
Depending on the kind of real-time query that was specified on subscription, the first message sent by the server may be a **result message** which contains all currently matching items in the specified order (if specified). Each message from this point on is either a **match message** (indicating a result update) or an **error message** (indicating query termination). By default, the client will receive a match message for every result update, so that the result can be maintained up-to-date locally by taking the corresponding action for each event. 

## Message Types

The messages described above can be separated into two basic types of messages:  

- **Client-to-Server (Request)** messages are sent *from the client towards the server* to initialize or terminate a real-time query. A request message is always one of the following:
    - *subscribe message*: initializes a real-time query.
    - *unsubscribe message*: terminates a real-time query.
- **Server-to-Client (Response)** messages are sent *from the server to the client* to keep the client up-to-date on how the query result currently looks. A response message is always one of the following.
    - *result message* (optional): carries the initial query result, i.e. all data items matching the query on subscription.
    - *match message*: carries a result change delta.
    - *error message*: terminates a real-time query because of some problem.

Every request and response message contains the following attributes:

- **id**: a UUID generated by the client and initially provided with the subscription message; required to distinguish between different subscriptions transmitted over the same websocket connection.
- **type**: required to distinguish between the different kinds of messages (`subscribe`, `unsubscribe`, `result`, `match`, `error`).

In the following section, we provide an example for each message type to illustrate message format. Additional information is provided in our [Event Stream Query Docs](./topics/realtime/#event-stream-queries). 

### Request Messages: From Client to Server

There are only two types of messages that are sent from the client to the server via websocket: subscribe messages and unsubscribe messages.

#### Subscribe Messages

A subscribe message initializes a real-time query and therefore encapsulates what information the client is interested in.  
A subscribe message may contain the following specific attributes:

- **token**: authorization user token or `null` for queries executed anonymously (sorted queries are currently always executed anonymously)
- **initial**: whether or not the initial result is requested
- **bucket**: the collection on which the query is performed
- **query**: a MongoDB query as string (will be parsed into a JSON object server-side)
- **sort**: a [MongoDB sort document](https://docs.mongodb.com/manual/reference/method/cursor.sort/) as string (will be parsed into a JSON object server-side)
- **offset**: an integer indicating the number of items to skip; e.g. an offset of `20` in a sorted query result means the result will only contain items with index 20, 21, 22 and so forth
- **limit**: an integer indicating the maximum number of items in the result set
- **operations**: the operations that can trigger an event (Warning: [complex semantics for non-default values](./topics/realtime/#example-subscription-and-events)!)
- **matchTypes**: the match types that the client is interested in

<div class="note"><strong>Note:</strong> 
When creating a subscribe message, the client has to provide a unique string (<b>UUID</b>) for the <code>id</code> attribute.
</div> 

Example subscribe message:

```javascript
{
  "id": "be22181e-8561-445f-99a1-97ec2d4e253f",
  "type": "subscribe",
  "token": null,
  "initial": true,
  "bucket": "eventbucket",
  "query": "{\"value\" : 42}",
  "sort": "{\"name\": 1}",
  "offset": 20,
  "limit": 10,
  "operations": [
    "any"
  ],
  "matchTypes": [
    "all"
  ]
}
```

#### Unsubscribe Messages

An unsubscribe message terminates the specified subscription. It does not have any specific attributes.

Example unsubscribe message:

```javascript
{
  "id": "be22181e-8561-445f-99a1-97ec2d4e253f",
  "type": "unsubscribe"
}
```


## Response Messages: From Server to Client

In addition to the `id` and `type` attributes, every message issued by the server has the following attribute:
- **date**: server time; the instant at which the message was generated.

#### Result Messages

A result message is always the first message sent to the client as it contains the complete initial query result. It is issued when and only when `initial: true` was specified on subscription.  
A result message always contains the following specific attribute:

- **data**: the initial result as a list of JSON documents; for sorted queries, item order obeys the specified order

Example result message:

```javascript
{
  "id": "be22181e-8561-445f-99a1-97ec2d4e253f",
  "type": "result",
  "date": "2017-08-17T05:02:46.467Z",
  "data": [
    {
      "id": "/db/eventbucket/23edf763-031a-42c1-b841-0d5a470f117d",
      "version": 1,
      "acl": null,
      "createdAt": "2017-08-17T05:02:45.54Z",
      "updatedAt": "2017-08-17T05:02:45.54Z",
      "date": null,
      "geo": null,
      "name": "Tim",
      "ref": null,
      "value": 42
    }
  ]
}
```

#### Match Messages

A match message encapsulates a change delta, i.e. a write operation that affected the query result.  
A result message always contains the following specific attributes:

- **matchType**: the match type; for example, `add` for an entity that entered the result or `remove` for a deleted entity
- **operation**: the operation that triggered the event: `insert`, `update`, `delete` or `none` (see [example](./topics/realtime/#example-subscription-and-events) for explanation)
- **index**: for sorted queries only; the position of the modified entity within the result list (`-1` for deletions)
- **data**: a JSON object representing the updated entity

Example match message:

```javascript
{
  "id": "be22181e-8561-445f-99a1-97ec2d4e253f",
  "type": "match",
  "date": "2017-08-17T05:02:46.848Z",
  "matchType": "add",
  "operation": "insert",
  "index": 0,
  "data": {
    "id": "/db/eventbucket/4ab39068-de17-45c2-b9b3-c571d7542c8b",
    "version": 1,
    "acl": null,
    "createdAt": "2017-08-17T05:02:46.829Z",
    "updatedAt": "2017-08-17T05:02:46.829Z",
    "date": null,
    "geo": null,
    "name": "Al",
    "ref": null,
    "value": 42
  }
}
```

#### Error Messages

An error message terminates a real-time query, informing the client that there was a problem and providing information on the cause.  
An error message always contains the following specific attribute:

- **error**: a JSON object representing the problem that occurred

Example error message:

```javascript
{
  "id": "be22181e-8561-445f-99a1-97ec2d4e253f",
  "type": "error",
  "date": "2017-08-17T05:07:38.008Z",
  "error": {
    "message": "Too many active subscriptions (only 20 allowed)!",
    "status": 429,
    "reason": "Too Many Requests"
  }
}
```

